cd /tmp/
wget https://files.phpmyadmin.net/phpMyAdmin/5.1.0/phpMyAdmin-5.1.0-all-languages.tar.gz
tar xvzf phpMyAdmin-5.1.0-all-languages.tar.gz
sudo mv phpMyAdmin-5.1.0-all-languages /usr/share/phpmyadmin

sudo mkdir -p /var/lib/phpmyadmin/tmp
sudo mkdir /etc/phpmyadmin/
sudo chown -R www-data:www-data /var/lib/phpmyadmin
sudo cp /usr/share/phpmyadmin/config.sample.inc.php /usr/share/phpmyadmin/config.inc.php

sed -i "s/$cfg['blowfish_secret'] = '';/$cfg['blowfish_secret'] = 'R:0pJnP{T5BQBPy/ANIfDLAJ0HUYPVee';/" /usr/share/phpmyadmin/config.inc.php
echo "$cfg['TempDir'] = '/var/lib/phpmyadmin/tmp';" >> /usr/share/phpmyadmin/config.inc.php

echo "<VirtualHost *:80>
    ServerAdmin admin@ehasa.org
    ServerName mysli.ehasa.org
    DocumentRoot /usr/share/phpmyadmin
<FilesMatch \.php$> 
    SetHandler
"proxy:unix:/run/php/php8.0-fpm.sock|fcgi://localhost/" 
</FilesMatch>
    ErrorLog ${APACHE_LOG_DIR}/phpmyadmin-error.log
    CustomLog ${APACHE_LOG_DIR}/phpmyadmin-access.log combined
    Redirect permanent / https://mysli.ehasa.org
</VirtualHost>
<VirtualHost *:443>
    ServerAdmin admin@ehasa.org
    ServerName mysli.ehasa.org
    DocumentRoot /usr/share/phpmyadmin
        SSLEngine on
        SSLCertificateFile      /etc/letsencrypt/live/ehasa.org/cert.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/ehasa.org/privkey.pem
        SSLCertificateChainFile /etc/letsencrypt/live/ehasa.org/chain.pem
<FilesMatch \.php$> 
    SetHandler
"proxy:unix:/run/php/php8.0-fpm.sock|fcgi://localhost/" 
</FilesMatch>
    ErrorLog ${APACHE_LOG_DIR}/phpmyadmin-error.log
    CustomLog ${APACHE_LOG_DIR}/phpmyadmin-access.log combined
</VirtualHost>" > /etc/apache2/sites-available/mysli.ehasa.org.conf
echo "<Directory /usr/share/phpmyadmin>
    AuthType Basic
    AuthName "Restricted Content"
    AuthUserFile /etc/apache2/.htpasswd
    Require valid-user
</Directory>" >> /etc/apache2/apache2.conf
a2ensite mysli.ehasa.org.conf

service restart apache2
